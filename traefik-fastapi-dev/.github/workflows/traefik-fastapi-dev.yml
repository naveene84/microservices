name: Traefik + FastAPI Dev Deployment

on:
  push:
    branches:
      - self-hosted
  pull_request:

jobs:
  traefik-fastapi:
    name: deploy Traefik + simple FastApi
    runs-on: self-hosted 

    steps:
      # 1. Checkout source code
      - name: Checkout repository
        uses: actions/checkout@v4

      #2 Build the FastApi image
      - name: Build the FastApi image
        run: !
          docker build -t fastapi .traefik-fastapi-dev/app

      # 3. Start Traefik + FastAPI services
      - name: Start containers
        run: |
          docker-compose up -d --build

      # 5. Verify containers are running
      - name: List running containers
        run: docker ps

      # 6. Wait for services to be ready
      - name: Wait for FastAPI
        run: sleep 10

      # 7. Test FastAPI through Traefik load balancer
      - name: Health check via Traefik
        run: |
          curl -f http://localhost || exit 1

      # 8. Show Traefik logs if failure happens
      - name: Show Traefik logs on failure
        if: failure()
        run: docker logs traefik

      # 9. Cleanup (always runs)
      - name: Shutdown containers
        if: always()
        run: docker-compose down
