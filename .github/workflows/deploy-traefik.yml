name: Deploy Traefik + Single Flask Instance

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy-single:
    name: Deploy Traefik + single Flask instance
    runs-on: self-hosted
    env:
      APP_HOST: flask.local
      APP_IMAGE: flaskapp:latest
      APP_PORT: 5000
      # Added a specific tag for the Traefik image for more predictable deployments
      TRAEFIK_IMAGE: traefik:v2.11 

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure traefik directory & static config
        run: |
          set -euo pipefail
          mkdir -p traefik
          # Create a minimal traefik static config if it doesn't exist
          if [ ! -f "traefik/traefik.yml" ]; then
cat > "traefik/traefik.yml" <<'EOF'
entryPoints:
  web:
    address: ":80"
  websecure:
    address: ":443"

api:
  dashboard: true
  insecure: true

providers:
  docker:
    endpoint: "unix:///var/run/docker.sock"
    exposedByDefault: false

certificatesResolvers:
  myresolver:
    acme:
      email: your-email@example.com
      storage: /acme.json
      httpChallenge:
        entryPoint: web
EOF
          fi

      - name: Ensure acme.json exists and is secure
        run: |
          touch traefik/acme.json
          chmod 600 traefik/acme.json

      - name: Build Flask app image
        run: |
          set -euo pipefail
          # Assumes the Dockerfile for the app is in the 'app' directory
          docker build -t "$APP_IMAGE" ./app

      - name: Stop any existing containers
        run: |
          # This prevents the workflow from failing if the containers don't exist
          docker rm -f traefik flaskapp || true

      - name: Ensure docker network 'web' exists
        run: |
          docker network inspect web >/dev/null 2>&1 || docker network create web

      - name: Pull Traefik image
        run: docker pull $TRAEFIK_IMAGE

      - name: Run Traefik container
        run: |
          set -euo pipefail
          docker run -d --name traefik \
            --network web \
            -p 80:80 -p 443:443 -p 8080:8080 \
            -v /var/run/docker.sock:/var/run/docker.sock:ro \
            -v "$PWD/traefik/traefik.yml":/etc/traefik/traefik.yml:ro \
            -v "$PWD/traefik/acme.json":/acme.json \
            --restart=always \
            $TRAEFIK_IMAGE

      - name: Wait for Traefik dashboard to be ready
        run: |
          set -euo pipefail
          echo "Waiting for Traefik to start..."
          for i in $(seq 1 30); do
            if curl -fsS http://127.0.0.1:8080/api/rawdata >/dev/null 2>&1; then
              echo "Traefik dashboard is up!"
              exit 0
            fi
            sleep 1
          done
          echo "Error: Traefik failed to start or dashboard not accessible." >&2
          docker logs traefik || true
          exit 1

      - name: Run Flask app container (single instance)
        run: |
          set -euo pipefail
          docker run -d --name flaskapp --network web \
            -e "FLASK_ENV=production" \
            -l "traefik.enable=true" \
            -l "traefik.http.routers.flask.rule=Host(`$APP_HOST`)" \
            -l "traefik.http.routers.flask.entrypoints=web" \
            -l "traefik.http.services.flask-service.loadbalancer.server.port=$APP_PORT" \
            "$APP_IMAGE"

      - name: Verify app responds through Traefik
        id: verify
        run: |
          set -euo pipefail
          # Wait a moment for the flask app to be registered by Traefik
          sleep 5
          echo "Verifying Flask app is accessible via Traefik..."
          
          # Use --fail to make curl exit with an error on HTTP failure codes
          if curl -fsS -H "Host: $APP_HOST" http://127.0.0.1/; then
            echo "Verification successful!"
            echo "APP_OK=true" >> "$GITHUB_OUTPUT"
          else
            echo "Error: App did not respond correctly through Traefik." >&2
            docker logs flaskapp || true
            exit 1
          fi

      - name: Optional cleanup (set CLEANUP env var to 'true')
        if: env.CLEANUP == 'true'
        run: |
          echo "Cleaning up containers..."
          docker rm -f flaskapp traefik || true
