name: Deploy Traefik + Single Flask Instance

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy-single:
    name: Deploy Traefik + single Flask instance
    runs-on: self-hosted
    env:
      APP_HOST: flask.local
      APP_IMAGE: flaskapp:latest
      APP_PORT: 5000

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure traefik directory & static config
        run: |
          set -euo pipefail
          mkdir -p "$GITHUB_WORKSPACE/traefik"
          # Create a minimal traefik static config if it doesn't exist
          if [ ! -f "$GITHUB_WORKSPACE/traefik/traefik.yml" ]; then
cat > "$GITHUB_WORKSPACE/traefik/traefik.yml" <<'EOF'
entryPoints:
  web:
    address: ":80"
  websecure:
    address: ":443"

api:
  dashboard: true
  # insecure: true exposes the dashboard without auth â€” useful for testing only
  insecure: true

providers:
  docker:
    endpoint: "unix:///var/run/docker.sock"
    exposedByDefault: false

certificatesResolvers:
  myresolver:
    acme:
      email: your-email@example.com
      storage: /acme.json
      httpChallenge:
        entryPoint: web
EOF
          fi

      - name: Ensure acme.json exists and is secure
        run: |
          touch "$GITHUB_WORKSPACE/traefik/acme.json"
          chmod 600 "$GITHUB_WORKSPACE/traefik/acme.json"

      - name: Build Flask app image
        run: |
          set -euo pipefail
          docker build -t "$APP_IMAGE" "$GITHUB_WORKSPACE/app"

      - name: Stop any existing containers
        run: |
          set -euo pipefail
          docker rm -f traefik || true
          docker rm -f flaskapp || true

      - name: Ensure docker network 'web' exists
        run: |
          set -euo pipefail
          docker network inspect web >/dev/null 2>&1 || docker network create web

      - name: Pull Traefik image
        run: docker pull traefik:latest

      - name: Run Traefik container
        run: |
          set -euo pipefail
          docker run -d --name traefik \
            --network web \
            -p 80:80 -p 443:443 -p 8080:8080 \
            -v /var/run/docker.sock:/var/run/docker.sock:ro \
            -v "$GITHUB_WORKSPACE/traefik/traefik.yml":/etc/traefik/traefik.yml:ro \
            -v "$GITHUB_WORKSPACE/traefik/acme.json":/acme.json \
            --restart=always \
            traefik:latest

      - name: Wait for Traefik dashboard to be ready
        run: |
          set -euo pipefail
          for i in $(seq 1 30); do
            if curl -fsS http://127.0.0.1:8080/dashboard/ >/dev/null 2>&1; then
              echo "traefik is up"
              exit 0
            fi
            sleep 1
          done
          echo "traefik failed to start or dashboard not accessible" >&2
          docker logs traefik || true
          exit 1

      - name: Run Flask app container (single instance)
        run: |
          set -euo pipefail
          docker run -d --name flaskapp --network web \
            -e "FLASK_ENV=production" \
            -l "traefik.enable=true" \
            -l "traefik.http.routers.flask.rule=Host(`$APP_HOST`)" \
            -l "traefik.http.routers.flask.entrypoints=web" \
            -l "traefik.http.services.flask-service.loadbalancer.server.port=$APP_PORT" \
            "$APP_IMAGE"

      - name: Verify app responds through Traefik
        id: verify
        run: |
          set -euo pipefail
          OUTDIR="$GITHUB_WORKSPACE/verify"
          mkdir -p "$OUTDIR"
          # Single request using Host header
          resp=$(curl -s -H "Host: $APP_HOST" http://127.0.0.1/ || true)
          echo "$resp" > "$OUTDIR/response.txt"
          if printf "%s" "$resp" | grep -q '"status": "ok\|Hello from the Flask app' ; then
            echo "APP_OK=true" >> "$GITHUB_OUTPUT"
          else
            echo "APP_OK=false" >> "$GITHUB_OUTPUT"
            cat "$OUTDIR/response.txt" >&2
            exit 1
          fi

      - name: Upload verification artifact
        uses: actions/upload-artifact@v4
        with:
          name: traefik-flask-single-verification
          path: |
            ${{ github.workspace }}/verify/response.txt

      - name: Optional cleanup (set CLEANUP=true)
        if: ${{ env.CLEANUP == 'true' }}
        run: |
          set -euo pipefail
          docker rm -f flaskapp || true
          docker rm -f traefik || true
