name: Deploy to Cloud Run (OIDC)

on:
  push:
    branches:
      - fastapi-in-cloudrun

env:
  PROJECT_ID: "project-9e6b8a1b-ac7b-4870-993"
  PROJECT_NUMBER: "909234899256"
  AR_REPO: "cloud-run-source-deploy"
  CLOUD_RUN_SERVICE: "github-cloudrun-deployer"
  CLOUD_RUN_REGION: "asia-south2"
  # Use the exact resource name format
  WIP: "projects/909234899256/locations/global/workloadIdentityPools/github-pool/providers/github-provider"
  SA_EMAIL: "github-oidc@project-9e6b8a1b-ac7b-4870-993.iam.gserviceaccount.com"
  IMAGE_NAME: "ghcr.io/${{ github.repository }}/fastapi:latest"

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      packages: write

    steps:

        - name: Checkout repository
          uses: actions/checkout@v4
        
        - name: Login to GHCR
          uses: docker/login-action@v3
          with:
            registry: ghcr.io
            username: ${{ github.actor }}
            password: ${{ secrets.GITHUB_TOKEN }}

        - name: Build Docker image
          run: |
            docker build -t $IMAGE_NAME .

        - name: Push Docker image to GHCR (optional)
          continue-on-error: true
          run: |
            docker push $IMAGE_NAME || echo "Skipping GHCR push"
        
        - id: auth
          name: Authenticate to Google Cloud
          uses: google-github-actions/auth@v2
          with:
            workload_identity_provider: ${{ env.WIP }}
            service_account: ${{ env.SA_EMAIL }}

        - name: Set up gcloud
          uses: google-github-actions/setup-gcloud@v2
        
        - name: Ensure Artifact Registry repo exists
          run: |
            set -euo pipefail
            gcloud artifacts repositories describe ${{ env.AR_REPO }} \
              --location=${{ env.CLOUD_RUN_REGION }} >/dev/null 2>&1 || \
            gcloud artifacts repositories create ${{ env.AR_REPO }} \
              --repository-format=docker \
              --location=${{ env.CLOUD_RUN_REGION }} \
              --description="Cloud Run images"

        - name: Configure Docker auth for Artifact Registry
          run: |
            gcloud auth configure-docker ${{ env.CLOUD_RUN_REGION }}-docker.pkg.dev --quiet

        - name: Push image to Artifact Registry
          run: |
            set -euo pipefail
            AR_IMAGE="${{ env.CLOUD_RUN_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/${{ env.CLOUD_RUN_SERVICE }}:${{ github.sha }}"
            docker tag $IMAGE_NAME "$AR_IMAGE"
            docker push "$AR_IMAGE"
            echo "AR_IMAGE=$AR_IMAGE" >> $GITHUB_ENV

        - name: Deploy to Cloud Run (Artifact Registry image)
          run: |
            set -euo pipefail
            gcloud run deploy ${{ env.CLOUD_RUN_SERVICE }} \
              --project ${{ env.PROJECT_ID }} \
              --region ${{ env.CLOUD_RUN_REGION }} \
              --image "$AR_IMAGE" \
              --port 8080 \
              --timeout 300 \
              --platform managed \
              --allow-unauthenticated \
              --min-instances 0
      